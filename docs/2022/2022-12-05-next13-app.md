---
title: Next.js v12 ã‹ã‚‰ v13 with app dir ã«ç§»è¡Œã™ã‚‹
create: "2022-12-05"
tags: [nextjs, next-mdx-remote, algolia]
description: ""
published: true
---

è¤‡æ•°ã‚ã‚‹ Next.js è£½ã‚µã‚¤ãƒˆã®ãªã‹ã§ã€ã“ã®ãƒ–ãƒ­ã‚°ãŒæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã§ãƒšãƒ¼ã‚¸æ•°ãŒå°‘ãªã„ã€ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å…ˆãŒ Vercelã€æœªå¯¾å¿œã® StaticExport ã‚’ä½¿ã£ã¦ã„ãªã„ãªã©ã®ç†ç”±ã‹ã‚‰è©¦ã—ã«ç§»è¡Œã™ã‚‹ã“ã¨ã«ã—ãŸã€‚åŸºæœ¬çš„ã«ã¯[Upgrade Guide | Next.js](https://beta.nextjs.org/docs/upgrade-guide)ã«å¾“ã„ã¤ã¤ã€å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢é€£ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ããŸã¨ãã¯ãã‚Œãã‚Œã® GitHub ãƒ¬ãƒã‚¸ãƒˆãƒªã® issue ç­‰ã§ç¢ºèªã—ãªãŒã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ããŸã„ã¨æ€ã†ã€‚

Next.js v12 ã‹ã‚‰ v13 ã¸ã®å¤‰æ›´ç‚¹ã‚’èª­ã‚“ã æ„Ÿã˜ã ã¨ã€æ¤œç´¢æ©Ÿèƒ½ã®[Algolia](https://www.algolia.com/) ã‚„ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’å‡¦ç†ã™ã‚‹[hashicorp/next-mdx-remote](https://github.com/hashicorp/next-mdx-remote) ãªã©ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å‹•ãè¾ºã‚Šã§ã‚¨ãƒ©ãƒ¼ã«é­é‡ã™ã‚‹ã®ã ã‚ã†ã¨æ€ã†ã€‚

## è¦ç´„

> ğŸ—ï¸ The app directory is currently in beta and we do not recommend using it in production.
> > [Getting Started | Next.js](https://beta.nextjs.org/docs)

Next.js beta docs ã«ã‚ã‚‹ã‚ˆã†ã«ã€`app/` ã¯ã¾ã  production ç’°å¢ƒä¸‹ã§ä½¿ã†ã®ã¯ãƒ„ãƒ©ãã€å€‹äººçš„ã«ã¯`<Head />`ã®ä»£ã‚ã‚Šã®`head.tsx`ã‚’å„ãƒšãƒ¼ã‚¸ã”ã¨ã«ä½œã‚‰ãªã„ã¨ã„ã‘ãªã„ä¸Šã«æŒ™å‹•ãŒã¡ã‚‡ã£ã¨ä¸å®‰å®šãªã®ãŒãƒ»ãƒ»ãƒ»ã“ã®ãƒ–ãƒ­ã‚°ã ã‘ã§ã‚‚ç§»è¡Œã—ã¦ã¿ã‚ˆã†ã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒå¾Œå›ã—ã«ã—ã¾ã—ãŸã€‚

## ç§»è¡Œå‰ã®ç’°å¢ƒ

- Next.js v12
  - TypeScript
  - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å‡¦ç†ï¼š[hashicorp/next-mdx-remote](https://github.com/hashicorp/next-mdx-remote)
  - CSS: TailwindCSS
    - [CSSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ goober ã‹ã‚‰ TailwindCSS ã«ç§»è¡Œã—ãŸ | blog.oriverk.dev](https://blog.oriverk.dev/entry/2022/20221116-next-ts-tailwind/)
  - æ¤œç´¢ï¼š[Algolia/react-instantsearch/packages/react-instantsearch-hooks-web](https://github.com/algolia/react-instantsearch/tree/master/packages/react-instantsearch-hooks-web)

## ç§»è¡Œå‰ã®ä¸»ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

- `src/`
  - `types/`, `utils/`, `hooks/`, `components/`, `styles/`
- `pages/`ï¼šåŸºæœ¬çš„ã« view ã ã‘
  - `_app.tsx`, `_document.tsx`
  - `index.tsx`ï¼šæŠ•ç¨¿ä¸€è¦§
  - `404.tsx`
  - `feed.xml.tsx`, `sitempa.xml.tsx`
  - `entry/`
    - `[...slug].tsx`ï¼šæŠ•ç¨¿è©³ç´° e.g. '/2022/20221114-next13-upgrade'
- `docs/`ï¼šãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  - 2022
    - `20221114-next13-upgrade.md`
- `public/`

## ã‚„ã£ãŸã“ã¨

Next.js ã‚„ ESLint ãªã©å„ç¨®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯ã‚¬ã‚¤ãƒ‰é€šã‚Šãªã®ã§çœç•¥ã™ã‚‹ã€‚ãŸã ã€Eslint ã®`@typescript-eslint/typescript-estree`ãŒTypeScript@4.9.3ã‚’æœªã‚µãƒãƒ¼ãƒˆ(2022.11.19 æ™‚ç‚¹)ã ã£ãŸã®ã§ã€ä»£ã‚ã‚Šã«TypeScript@4.6.3ã‚’å…¥ã‚ŒãŸã€‚

### `app`dirã®æœ‰åŠ¹åŒ–ã¨å„ç¨®`.config`ãªã©è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£

â€»`app/` ã¯ã¾ã ãƒ™ãƒ¼ã‚¿æ©Ÿèƒ½ãªã®ã§æ³¨æ„ï¼ˆ2022.11.19 æ™‚ç‚¹ï¼‰

```javascript:next.config.js
/** @type {import('next').NextConfig} */

const withBundleAnalyzer = process.env.ANALYZE === 'true'
    ? require('@next/bundle-analyzer')({ enabled: true })
    : (config) => config;

const defaultConfig = {
  experimental: {
    appDir: true
  },
  // ~
}

module.exports = withBundleAnalyzer(defaultConfig)
```

```json:package.json
{
  "scripts": {
    "lint:prettier": "prettier --check {src,app,pages}/**/*.{js,jsx,ts,tsx}",
  }
}
```

```javascript:tailwind.config.js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "src/**/*.{js,ts,jsx,tsx}",
    "app/**/*.{js,ts,jsx,tsx}",
    "pages/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {},
  },
  plugins: [require('@tailwindcss/typography'),],
}
```

### app dirä¸‹ã«`{layout,head,page}.tsx`ã‚’è¿½åŠ 

å„ç¨®è¨­å®šã®å¤‰æ›´ã‚’çµ‚ãˆãŸã®ã¡ã«ã€è©¦ã—ã« app/ ã‚’ä½œæˆã—ã€[Step 2: Creating a Root Layout | Next.js](https://beta.nextjs.org/docs/upgrade-guide#step-2-creating-a-root-layout)ã‚’å‚è€ƒã«ã€app/ä¸‹ã«`{layout,head,page}.tsx`ã‚’ä½œæˆã—ã¦ã¿ã‚‹ã€‚ãªãŠã€v12 ç’°å¢ƒä¸‹ã§`localhost:3000/`ã‚„`oriverk.dev/`ã‚’è¡¨ç¤ºã—ã¦ã„ãŸ`pages/index.tsx`ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã¯ã€v13 ã‹ã‚‰`app/page.tsx`ã«ãªã£ãŸã€‚ãªã®ã§ã€å…ƒã‹ã‚‰ã‚ã‚‹`pages/index.tsx`ã¯`pages/hoge.tsx`ã¨åå‰ã‚’å¤‰æ›´ã—ã¦ãŠãã€‚

```javascript:/app/page.tsx
export default function Page() {
  return <div>app/page.tsx</div>
}
```

`npm run dev`

![image](https://i.imgur.com/OOsYcEg.png "minimum /app/page.tsx")

ã¾ãŸã€`pages/hoge.tsx`ã‚‚å…±å­˜ã§ãã¦ã„ã‚‹ã€‚

![image](https://i.imgur.com/grhvbpz.png "pages/hoge.tsx")

ã“ã“ã§ã€`pages/hoge.tsx`ã‚‚åˆ©ç”¨ã—ã¦ã„ã‚‹ TailwindCSS ã®`/src/styleds/globals.scss`ã‚’`/app/page.tsx`ã§ã‚‚åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€`/page/layout.tsx`ã§ import ã—ã€`app/page.tsx`ã«`className="text-red-500"`ã‚’è¿½åŠ ã™ã‚‹ã¨

```javascript:/app/layout.tsx
import "../src/styles/globals.scss"

export default function RootLayout({ children }) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  );
}
```

![image](https://i.imgur.com/muYWVaR.png "import scss from /src/styles/ at app/page.tsx")

### Data fetching ã¨ Static Genrateã®ä¿®æ­£

> Next.js APIs such as getServerSideProps, getStaticProps, and getInitialProps are not supported in the new app directory.
> > [Data Fetching: Fundamentals | Next.js](https://beta.nextjs.org/docs/data-fetching/fundamentals)

v12 ã¾ã§ SG ã«ä½¿ç”¨ã—ã¦ã„ãŸ`getStaticPaths`ã¨`getStaticProps`ã¯å»ƒæ­¢ã•ã‚Œã€v13 ã‹ã‚‰ã¯ä»£ã‚ã‚Šã«`generateStaticParams`ã‚„`async function getData()`ï¼ˆä»»æ„ã®é–¢æ•°åï¼‰ãŒä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

#### æŠ•ç¨¿ä¸€è¦§ãƒšãƒ¼ã‚¸

`app/page.tsx`ã¯ã€utils/ã«ã‚ã‚‹`getPostsData`ã§ docs/ä¸‹ã® md ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ frontMatter ã‚’æŠ½å‡ºã—ãŸã‚‚ã®ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€ServerComponents(SC)ã§å•é¡Œãªã„ã€‚

```javascript:/app/page.tsx
import { getPostsData } from "@src/utils/markdown/getContentData"

async function getData() {
  const { posts } = await getPostsData();
  return posts;
}

export default async function Page() {
  const posts = await getData();
  
  return (
    <>
      <div className="text-red-500">app/page.tsx</div>
      <pre>
        {JSON.stringify(posts, null, 2)}
      </pre>
    </>
  )
}
```

![image](https://i.imgur.com/FcuqE3O.png "get posts at /app/page.tsx")

#### æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸

æŠ•ç¨¿è©³ç´°ãƒšãƒ¼ã‚¸ã§ã¯`/docs/2021/markdonw-guide.mdx`ã¨ã„ã£ãŸ md ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`location.origin/entry/2021/markdown-guide`ã®ã‚ˆã†ãªãƒ‘ã‚¹ã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€v12 ã¾ã§ã¯[dynamic routes ã® Catch all routes
](https://nextjs.org/docs/routing/dynamic-routes#catch-all-routes)ã‚’åˆ©ç”¨ã—ã€`/pages/entry/[...slug].tsx`ã¨ãªã£ã¦ã„ãŸã€‚v13 ã‹ã‚‰ã® app/åˆ©ç”¨ä¸‹ã§ã¯`/pages/entry/[...slug]/page.tsx`ã¨ãªã‚‹ã€‚

```javascript:/app/posts/[...slug]/page.jsx
export default function Page({ params, searchParams }) {
  return (
    <>
      <p>{JSON.stringify(params.slug, null, 2)}</p>
      <p>{JSON.stringify(searchParams, null, 2)}</p>
    </>
  );
}
```

v13 app/ ç’°å¢ƒä¸‹ã§ã® TypeScript ãŒå…¬å¼ã§å®Ÿè£…é€”ä¸­ãªãŸã‚ã«è‡ªåˆ†ã§å‹å®šç¾©ã—ãªã„ã¨ã„ã‘ãªã„ã¨è¨€ã†ã“ã¨ä»¥å¤–ã¯ã€åŸºæœ¬çš„ã« v12 ä»¥å‰ã¨åŒã˜æ„Ÿã˜ã€‚

![image](https://i.imgur.com/sLPdVIz.png "minimum catch-all dynamic routes")

```javascript:/app/posts/[...slug]/page.jsx
import { getPostsData } from "@src/utils/markdown/getContentData";

export async function generateStaticParams() {
  const { posts } = await getPostsData();
  const params = posts.map(({ fileName }) => {
    return {
      slug: fileName.split("/")
    }
  })
  return params
}

async function getData(params: any) {
  const fileName = params.slug.join("/");
  const { posts } = await getPostsData();
  const post = posts.find((post) => post.fileName === fileName);  
  return post
}

export default async function Page({ params, searchParams }) {
  const post = await getData(params)
  return <p>{JSON.stringify(post, null, 2)}</p>
}
```

![image](https://i.imgur.com/sreAKTT.png)

### 3rd party ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é©åˆ‡ã«ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹

ä»Šå›ã® Next.js v13 ã‹ã‚‰ `useEffect` ã‚„ `useState`ãªã©ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å‹•ã ClientComponents (CC) ã§ã¯`use client`ã¨è¨˜è¼‰ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€è¨˜è¼‰ã•ã‚Œã¦ãªã„ã‚‚ã®ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å‹•ãã‚ˆã†ã«ãªã£ãŸã€‚ãŸã ã€Next.js ã‹ã‚‰ã¯å„ç¨®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒ client ã§å‹•ãã‹ã‚’åˆ¤åˆ¥ã§ããªã„ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ CC ã¨ã—ã¦ãƒ©ãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã¾ãŸã€SC ã‹ã‚‰ CC ã«æ¸¡ã›ã‚‹ props ã«ã‚‚åˆ¶é™ãŒã‚ã‚Šã€ä¾‹ãˆã°é–¢æ•° Function ã‚„ Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ãƒ¢ãƒã¯ç›´æ¥æ¸¡ã›ãªã„ã€‚

- å‚ç…§
  - [Third-party packages | Next.js](https://beta.nextjs.org/docs/rendering/server-and-client-components#third-party-packages)
  - [Passing props from Server to CC | Next.js](https://beta.nextjs.org/docs/rendering/server-and-client-components#passing-props-from-server-to-client-components-serialization)
  - [Serialization - MDN Web Docs Glossary: Definitions of Web-related terms | MDN](https://developer.mozilla.org/en-US/docs/Glossary/Serialization)

#### next-mdx-remote

next-mdx-remote ã¯ docs/ã‹ã‚‰ mdx?ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å‡¦ç†ã™ã‚‹ã®ã«åˆ©ç”¨ã—ã¦ã„ã‚‹ã€‚`useEffect`ãªã©ãŒå†…éƒ¨ã§ä½¿ã‚ã‚Œã¦ãŠã‚Šã€`use client`ã§åŒ…ã‚€å¿…è¦ãŒã‚ã‚‹ã€‚

- [Does not yet support Next.js Version 13 Â· Issue #307 Â· hashicorp/next-mdx-remote](https://github.com/hashicorp/next-mdx-remote/issues/307)

å‡¦ç†ã—ãŸ md ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ç”¨ã„ã‚‹`<MDXRemote />`ã«æ¸¡ã™ã‚‚ã®ã¯ä¸»ã« 2 ã¤ã‚ã‚Šã€å‹ã¯ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã‚‹ã€‚components ã®æ–¹ã¯å…ˆè¿°ã—ãŸ SC ã‹ã‚‰ CC ã«æ¸¡ã›ãªã„ã‚‚ã®ãªã®ã§ã€`components`ã‚’å«ã‚ãŸå½¢ã§ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```typescript:next-mdx-remote
type Props = {
  compliedSource: string;
  components: Record<string, (props: any) => JSX.Element>
}
```

ãªã®ã§

```typescript:next-mdx-remote.tsx
"use client";

import { MDXRemote, MDXRemoteSerializeResult } from 'next-mdx-remote'
import { MDXComponents } from './mdx-components';

type Props = Pick<MDXRemoteSerializeResult, "compiledSource">;

export const NextMDXRemote: React.FC<Props> = ({ compiledSource }) => (
  <MDXRemote components={MDXComponents} compiledSource={compiledSource} />
)
```

ã“ã‚Œã§ç„¡äº‹å‹•ãã‚ˆã†ã«ãªã£ãŸã€‚

## ãã®ä»–

`next/head`ã®`<Head />`ãŒç„¡ããªã‚Šã€ä»£ã‚ã‚Šã«`head.tsx`ã§æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã ãŒæŒ™å‹•ãŒæ€ªã—ã„ã€‚ã€‚production ç’°å¢ƒç”¨ã«ã¯ã¡ã‚‡ã£ã¨ã¾ã æ™‚æœŸå°šæ—©ã‹ãªæ„Ÿã‚ã£ãŸã€‚

## å‚ç…§

- Next.js
  - [Upgrade Guide | Next.js](https://beta.nextjs.org/docs/upgrade-guide)
  - [App Directory Roadmap | Next.js](https://beta.nextjs.org/docs/app-directory-roadmap)
  - [Rendering: Server and Client Components | When to use Server vs. Client Components? | Next.js](https://beta.nextjs.org/docs/rendering/server-and-client-components#when-to-use-server-vs-client-components)
- [Install Tailwind CSS with Next.js using the app dir - Tailwind CSS](https://tailwindcss.com/docs/guides/nextjs#app-directory)
- [å€‹äººãƒ–ãƒ­ã‚°ã® Next.js v13 ç§»è¡Œã§ã‚„ã£ãŸã“ã¨ã¾ã¨ã‚](https://zenn.dev/panda_program/scraps/6c66f160636969)
- Repositry
  - [vercel/app-playground: https://app-dir.vercel.app/](https://github.com/vercel/app-playground)
  - [shadcn/taxonomy: An open source application built using the new router, server components and everything new in Next.js 13.](https://github.com/shadcn/taxonomy)
